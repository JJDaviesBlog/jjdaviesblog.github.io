<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="challenge_style.css">
    <title>Challenge</title>
</head>
<body>
    <h2 id="problemTitle"></h2>
    <p id="problemDesc"></p>
    <p>Note: You will need to add the parameters into the function yourself.</p>
    <p id="problemDiff"><b></b></p>
    <br>
    <div class="languages">
        <button id="selectedLang" class="selectedLang">JavaScript</button>
        <div class="dropdown-content">
            <a href="#" onclick="changeLang('JavaScript')">JavaScript</a>
            <a href="#" onclick="changeLang('Python3')">Python3</a>
        </div>
    </div>
    <br>
    <textarea id="code" class="code" style="height: 200px; width: 500px; background-color: rgb(16, 24, 32); color: rgb(0, 190, 44);"></textarea>
    <br>

    <div class="btns">
        <button onclick="startTimer()" class="btnTimerStart">Start Timer</button>
        <button onclick="submitEarly()" id="btnSubmit" class="btnSubmit">Submit Code Early</button>
    </div>
    <h3 id="countdown">Countdown will go here when the timer starts.</h3>
    <h3 id="smth" class="smth"></h3>
    <h3 id="result" class="result"></h3>

    <script type="text/javascript">
        // get the chosen problem
        const params = new URLSearchParams(window.location.search);
        const chosen = params.get('chosen');
        const solutions = params.get('solutions');

        // this works
        // let a = [];
        // a[0] = "hi";
        // a[1] = 2;
        // console.log(a);

        // default the language used to JavaScript
        let progLang = "JavaScript";

        document.getElementById("problemTitle").innerHTML = chosen.split("||")[0];
        document.getElementById("problemDesc").innerText = chosen.split("||")[1];
        let diff = chosen.split("||")[2];
        document.getElementById("problemDiff").innerText = `Difficulty: ${diff}`;

        if (diff == "Easy") {
            document.getElementById("problemDiff").style.color = "#059862";
        } else if (diff == "Medium") {
            document.getElementById("problemDiff").style.color = "#ffc01e"
        } else if (diff == "Hard") {
            document.getElementById("problemDiff").style.color = "#ff375f"
        }

        let textarea = document.getElementById("code");
        let btnSubmit = document.getElementById("btnSubmit");

        let countdownInterval;

        // FUNCTIONS AREA //

        function changeLang(language) {
            progLang = language;
            document.getElementById("selectedLang").innerHTML = language;
        }

        function hideElements() {
            textarea.style.visibility = "hidden";
            btnSubmit.style.visibility = "hidden";
        }

        function timerFinished() {
            document.getElementById("countdown").innerText = "";
            document.getElementById("result").innerText = "Time's up!";
            textarea.style.visibility = "hidden";
            setTimeout(evalCode, 1500);
        }

        function evalCode() {
            document.getElementById("smth").innerText = "Let's evaluate your code...";
            let givenCode = document.getElementById("code").value;
            let s = solutions.split("|");
            let allAns = [];

            if (progLang == "JavaScript") {
                givenCode += `
                let answers = [];
            
            `
                for (let i = 0; i < s.length; i++) {
                    let current = s[i].split("_");
                    let testCase = current[0];
                    let expected = current[1];

                    let t = `
                    answers[${i}] = (${testCase} == ${expected}) // expected ans: ${expected}
                    `
                    givenCode += t;
                }

                givenCode += `
                j = 1;
                document.getElementById("result").innerText = "";
                for (let a in answers) {
                    if (a) {
                        document.getElementById("result").innerText += \`
                        Test case \${j}: passed\`;
                    } else {
                        document.getElementById("result").innerText += \`
                        Test case \${j}: failed\`;
                    }
                    j+=1
                }
                `
                eval(givenCode);
            }
        }

        function startTimer() {
            textarea.style.visibility = "visible";
            btnSubmit.style.visibility = "visible";

            // setting language
            if (progLang == "JavaScript") {
                textarea.innerText = `function ${chosen.split("||")[3]}() { //code goes here }`
            } else if (progLang == "Python3") {
                textarea.innerText = `def ${chosen.split("||")[3]}(): # code goes here`
            }


            if (diff == "Easy") { // set a timer for 1 minutes (60 seconds), if easy mode
                timeLimit = 60; // seconds
            
            } else if (diff == "Medium") { // set a timer for 3 minutes (180 seconds), if medium mode
                timeLimit = 180; // seconds

            } else if (diff == "Hard") { // set a timer for 5 minutes (300 seconds), if hard mode
                timeLimit = 300; // seconds
            }

            document.getElementById("countdown").innerText = `Time left to complete: ${timeLimit} seconds`;
            countdownInterval = setInterval(function() {
                document.getElementById("countdown").innerText = `Time left to complete: ${timeLimit} seconds`;
                timeLimit -= 1;

                if (timeLimit == 0) {
                    clearInterval(countdownInterval);
                    timerFinished();
                }
            }, 1000);
        }

        function submitEarly() {
            clearInterval(countdownInterval);
            timerFinished();
        }

        // Hide the textarea when the page loads
        window.onload = hideElements;
    </script>
</body>
</html>